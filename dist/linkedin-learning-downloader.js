"use strict"; function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var a=(t,e,o)=>new Promise((r,n)=>{var s=l=>{try{d(o.next(l))}catch(m){n(m)}},c=l=>{try{d(o.throw(l))}catch(m){n(m)}},d=l=>l.done?r(l.value):Promise.resolve(l.value).then(s,c);d((o=o.apply(t,e)).next())});var _readline = require('readline'); var _readline2 = _interopRequireDefault(_readline);var _chalk = require('chalk'); var _chalk2 = _interopRequireDefault(_chalk);var N=class{out(e){let o=this.messageToColoredString(e);console.log(o)}promptUserInput(e){return new Promise(o=>{let r=this.messageToColoredString(e),n=this.readlineInterface;n.question(r,s=>{o(s.trim()),n.close()})})}promtUserUntilValidInput(e,o,r){return a(this,null,function*(){let n,s=!1;do n=yield this.promptUserInput(e),s=o(n),!s&&r&&this.out(r);while(!s);return n})}get readlineInterface(){return _readline2.default.createInterface({input:process.stdin,output:process.stdout})}messageToColoredString({text:e,type:o}){switch(o){case"success":return _chalk2.default.green.bold(e);case"info":return _chalk2.default.whiteBright(e);case"error":return _chalk2.default.red.bold(e);case"prompt":return _chalk2.default.cyan.bold(e);default:return e}}},i=new N;var _axios = require('axios'); var _axios2 = _interopRequireDefault(_axios);var O=class{constructor(){this.httpClient=_axios2.default}get(e,o,r){return this.httpClient.get(e,{params:o,headers:r})}downloadVideoFile(e){return this.httpClient.get(e,{responseType:"stream"})}},f=new O;var _fs = require('fs');function S(t,e,o){return a(this,null,function*(){let r=_fs.createWriteStream.call(void 0, e);i.out({text:`Downloading ${o} from 
${t.slice(0,20)}...`,type:"info"});let{data:n}=yield f.downloadVideoFile(t);return new Promise((s,c)=>{n.pipe(r);let d=null;r.on("error",l=>{d=l,r.close(),c(l)}),r.on("close",()=>{d||s()})})})}var _jsdom = require('jsdom');function h(e){return a(this,arguments,function*({data:t}){let{window:{document:o}}=new (0, _jsdom.JSDOM)(t);return o})}function y(t,e){return`${++t} ${ee(e)}`}function ee(t){return t.replace(/[/:*?"<>|~#%&+{}\-\\]/g,"")}function b(t,e){return/\/$/.test(t)?`${t}${e}`:`${t}/${e}`}function P(t,e,o,r){return a(this,null,function*(){let n=0,s=t.length,c=[],d=[];if(yield Promise.all(t.map((l,m)=>a(this,null,function*(){let u=l.progressiveStreams.find(({width:v})=>v===e),p=`${y(m,l.title)}.${u.mediaType.split("/")[1]}`,g=u==null?void 0:u.streamingLocations[0].url,w=b(o,p);try{yield S(g,w,p),++n,i.out({text:`File successfully downloaded: ${p}`,type:"success"}),i.out({text:`Downloads progress: ${n} / ${s}`,type:"info"})}catch(v){i.out({text:`Error saving video ${p}: ${v.toString()}`,type:"error"}),c.push(`${p}
${g}`),d.push(l)}}))),i.out({text:`
Finished downloading videos: ${n} / ${t.length}`,type:"success"}),c.length){i.out({text:`
Unfortunately, ${c.length} videos could not be downloaded: ${c.join(`
`)}`,type:"error"});let l=r!=null?r:yield i.promtUserUntilValidInput({text:"Retry failed downloads (y/n)? ",type:"prompt"},m=>/^[yn]$/i.test(m));/y/i.test(l)&&(yield P(d,e,o))}})}var M=class{getAuthHeaders(){return a(this,null,function*(){return this.authHeaders||(this.authHeaders=(yield this.loadTokensFromFile())||(yield this.promptUserForTokens())),this.authHeaders})}loadTokensFromFile(){return a(this,null,function*(){let e=`${__dirname}/cookie.token`,o=`${__dirname}/csrf.token`;if(!_fs.existsSync.call(void 0, e)||!_fs.existsSync.call(void 0, o))return;try{let r=yield _fs.promises.readFile(e),n=yield _fs.promises.readFile(o),s={"csrf-token":n.toString(),cookie:r.toString()};if(!s.cookie||!s["csrf-token"])throw"Invalid tokens!";return s}catch(r){i.out({text:r.toString(),type:"error"})}})}promptUserForTokens(){return a(this,null,function*(){let e=yield i.promtUserUntilValidInput({text:"Please enter CSRF token:",type:"prompt"},Boolean),o=yield i.promtUserUntilValidInput({text:"Please enter the cookie:",type:"prompt"},Boolean);return{"csrf-token":e,cookie:o}})}},x=new M;function q(t){return t.reduce((e,o,r)=>{let n=_(o.transcriptStartAt),s=r===t.length-1;if(s)n+=`
`;else{let d=_(t[r+1].transcriptStartAt);n+=` --> ${d}
`}let c=`${++r}
${n}${o.caption}

`;return e+c},"")}function _(t){let e=(t%1e3).toLocaleString("en-US",{minimumIntegerDigits:3,useGrouping:!1}),o=Math.trunc(t/1e3).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1}),r=Math.trunc(t/1e3/60).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1}),n=Math.trunc(t/1e3/60/60).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1});return`${n}:${r}:${o},${e}`}function z(t){let e=Array.from(t.querySelectorAll('code[style="display: none"]')).find(n=>{var s;return(s=n.textContent)==null?void 0:s.includes("transcriptStartAt")});if(!e)throw"Could not locate subtitles on the page, check if they are missing";let o=JSON.parse(e.textContent.replace(/&quot/g,'"')),{lines:r}=o.included.find(({lines:n})=>Boolean(n));return r||[]}function C(t){return a(this,null,function*(){let e=yield x.getAuthHeaders();return f.get(t,void 0,e).then(h).then(z).then(q)})}function D(t,e,o,r){return a(this,null,function*(){let n=r!=null?r:yield i.promtUserUntilValidInput({text:`
Download subtitles? (y/n) `,type:"prompt"},s=>/^[yn]$/i.test(s));if(/^y$/i.test(n)){let s=0,c=t.videos.length;yield Promise.all(t.videos.map((u,p)=>a(this,[u,p],function*({title:d,slug:l},m){let g=`${y(m,d)}.srt`;try{let w=yield C(`${e}/${l}`);if(!w)throw"Could not find/parse subtitles";let v=b(o,g);yield _fs.promises.writeFile(v,w),++s,i.out({text:`File successfully downloaded: ${g}`,type:"success"}),i.out({text:`Subtitles downloaded: ${s} / ${c}`,type:"info"})}catch(w){i.out({text:`Could not get subtitles for ${g}: ${w.toString()}`,type:"error"})}}))),i.out({text:`
Finished downloading subtitles: ${s} / ${t.videos.length}.`,type:"success"})}})}function I(){return a(this,null,function*(){let t=yield i.promtUserUntilValidInput({text:`
Download another course? (y/n) `,type:"prompt"},e=>/^[yn]$/i.test(e));return/^n$/i.test(t)})}function $(t,e){return a(this,null,function*(){var c;let o=Array.from(t.querySelectorAll('code[style="display: none"]')).find(d=>{var l;return(l=d.textContent)==null?void 0:l.includes("exerciseFiles")});o||i.out({text:"No exercises found for the course.",type:"info"});let r=JSON.parse(o.textContent),n=r.included.find(d=>Boolean(d.exerciseFiles));if(!n||!((c=n.exerciseFiles)==null?void 0:c.length)){i.out({text:`
No exercises found for the course.`,type:"info"});return}i.out({text:`
Found ${n.exerciseFiles.length} exercises, downloading...`,type:"info"});let s=0;yield Promise.all(n.exerciseFiles.map((d,l)=>oe(d,e,l).then(m=>{i.out({text:`${m} has been downloaded.`,type:"success"}),i.out({text:`Download progress: ${++s} / ${n.exerciseFiles.length}`,type:"info"})}).catch(m=>i.out({text:m,type:"error"}))))})}function oe(t,e,o){return a(this,null,function*(){let r=y(o,t.name),n=t.url;return yield S(n,`${e}/${r}`,r),r})}function B(t,e,o){return a(this,null,function*(){let{data:r}=yield f.get("https://www.linkedin.com/learning-api/videos",e,o);try{let n={title:t.title,progressiveStreams:r.elements.map(s=>s.presentation.videoPlay.videoPlayMetadata.progressiveStreams).reduce((s,c)=>[...s,...c],[])};return n}catch(n){throw`${n.toString} 
Problematic videoResponse element:
 ${JSON.stringify(r)}
`}})}function F(t){return a(this,null,function*(){var l;let{parentSlug:e}=t,o="slugs",r=yield x.getAuthHeaders(),n=15e3,s=15e3,c=[],d=[];do{let m=d.length?d:t.videos;for(let u of m){i.out({text:`Requesting video options for ${u.title}...`,type:"info"});try{let p=yield B(u,{parentSlug:e,q:o,slug:u.slug},r);c.push(p),d=d.filter(({slug:g})=>g!==u.slug),i.out({text:"Success!",type:"success"})}catch(p){let g=((l=p==null?void 0:p.response)==null?void 0:l.status)===429;if(g)i.out({text:"Encountered error 429: too many requests",type:"error"});else throw p;d.push(u),yield new Promise(w=>{i.out({text:`
Sleeping for ${s/1e3} seconds before continuing to prevent 429 error
Videos resolved: ${c.length} / ${t.videos.length}`,type:"info"}),s+=n,setTimeout(()=>w(!0),s)})}}d.length&&i.out({text:`Retrying requests for ${d.length} videos...`,type:"info"})}while(d.length);return c})}function A(t,e){return a(this,null,function*(){var s;let o;o=(s=t.match(/\/([^/]+)$/))==null?void 0:s[1];let r=e.title,n=Array.from(e.querySelectorAll(".video__link")).map(c=>{var d,l,m,u;return{title:(l=(d=c.querySelector(".video__title"))==null?void 0:d.textContent)==null?void 0:l.trim(),slug:(u=(m=c.getAttribute("href"))==null?void 0:m.match(/\/([^/]+)\?/))==null?void 0:u[1].trim()}});return{listName:r,parentSlug:o,videos:n}})}function Y(t){return/^https?:\/\/(www\.)?linkedin\.com\/learning\/[a-z\-_\d]+$/.test(t)}function U(){return a(this,null,function*(){return i.promtUserUntilValidInput({text:`
Please enter url to a linkedin course you would like to download?
      i.e. https://www.linkedin.com/learning/critical-thinking-for-better-judgment-and-decision-making
`,type:"prompt"},t=>Y(t),{text:"Invalid course url entered, enter a valid one.",type:"error"})})}function j(t){return a(this,null,function*(){let e="";do{let o=yield i.promptUserInput({text:`
Please enter the path to the download folder:
`,type:"prompt"});if(/^\..+$/.test(o)&&(o=`${t}/${/[\\/]/.test(o[1])?o.slice(2):o}`),!_fs.existsSync.call(void 0, o)){i.out({text:`
Folder does not exist, trying to create it...`,type:"info"});try{_fs.mkdirSync.call(void 0, o),i.out({text:"Folder created!",type:"success"})}catch(r){i.out({text:`Error while trying to create folder: ${r.toString()}`,type:"error"});continue}}e=o}while(!e);return e})}function T(t){return a(this,null,function*(){let e=t.reduce((r,n)=>[...r,n.progressiveStreams.map(({width:s})=>s)],[]),o=t[0].progressiveStreams.map(({width:r})=>r).filter(r=>e.every(n=>n.includes(r)));return Number.parseInt(yield i.promtUserUntilValidInput({text:`
Please, select desired video width: ${o.join(", ")}: `,type:"prompt"},r=>o.map(String).includes(r)))})}function E(t){return a(this,null,function*(){let e=yield U(),o=yield f.get(e).then(h),r=yield A(e,o);i.out({text:ne(r.videos),type:"success"});let n=yield F(r),s=yield T(n);i.out({text:`Selected video width: ${s}`,type:"success"});let c=yield j(t);i.out({text:`Download path: ${c}
`,type:"info"}),yield P(n,s,c);let d=yield x.getAuthHeaders(),l=yield f.get(e,void 0,d).then(h);yield $(l,c),yield D(r,e,c)})}function ne(t){return`
Found ${t.length} videos:

${t.map(({title:e},o)=>`${++o}. ${e}.`).join(`
`)}`}function G(t){return a(this,null,function*(){let{courses:e,downloadRoot:o,videoSize:r,doDownloadSubtitles:n,doRetryFailedVideoDownloads:s}=t,c=/^.+\/$/.test(o)?o:`${o}/`;for(let d of e){i.out({text:`Downloading ${d}`,type:"info"});let l=yield f.get(d).then(h),m=yield A(d,l),u=yield F(m),p=c+d.replace(/^.+\//,"");_fs.mkdirSync.call(void 0, p),i.out({text:"Folder created!",type:"success"}),yield P(u,r,p,s);let g=yield x.getAuthHeaders(),w=yield f.get(d,void 0,g).then(h);yield $(w,p),yield D(m,d,p,n)}})}var W="download-config.json";function J(t){return a(this,null,function*(){let e=`${t}/${W}`;if(!_fs.existsSync.call(void 0, e))return null;try{let o=yield _fs.promises.readFile(e);return JSON.parse(o.toString())}catch(o){return null}})}function k(t){var o;let e;((o=t.response)==null?void 0:o.status)===403?e={text:`
Looks like your are not authorized to view the course or entered wrong cookie. Refer to the README to check how to obtain cookie/csrf token. 
Failed with error: ${t.toString()}`,type:"error"}:e={text:`
Looks like something has gone wrong.
Failed with error: ${t.toString()}`,type:"error"},i.out(e)}function R(){return a(this,null,function*(){i.out({text:`
Welcome to the Linkedin learning videos downloade v1!`,type:"info"});let t=!1,e=yield J(__dirname);if(e){i.out({text:"Found configuration file, trying to load videos from it",type:"info"});try{yield G(e)}catch(o){k(o)}finally{t=yield I()}}for(;!t;)try{yield E(__dirname)}catch(o){k(o)}finally{t=yield I()}i.out({text:`Bye bye!

`,type:"info"}),process.exit()})}R();
