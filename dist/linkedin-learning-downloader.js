"use strict"; function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var a=(t,e,o)=>new Promise((i,r)=>{var s=m=>{try{d(o.next(m))}catch(c){r(c)}},l=m=>{try{d(o.throw(m))}catch(c){r(c)}},d=m=>m.done?i(m.value):Promise.resolve(m.value).then(s,l);d((o=o.apply(t,e)).next())}),V=`
Welcome to the Linkedin learning videos downloade v1!`;var _readline = require('readline'); var _readline2 = _interopRequireDefault(_readline);var _chalk = require('chalk'); var _chalk2 = _interopRequireDefault(_chalk);var $=class{out(e){let o=this.messageToColoredString(e);console.log(o)}promptUserInput(e){return new Promise(o=>{let i=this.messageToColoredString(e),r=this.readlineInterface;r.question(i,s=>{o(s.trim()),r.close()})})}get readlineInterface(){return _readline2.default.createInterface({input:process.stdin,output:process.stdout})}messageToColoredString({text:e,type:o}){switch(o){case"success":return _chalk2.default.green.bold(e);case"info":return _chalk2.default.whiteBright(e);case"error":return _chalk2.default.red.bold(e);case"prompt":return _chalk2.default.cyan.bold(e);default:return e}}},n=new $;var _axios = require('axios'); var _axios2 = _interopRequireDefault(_axios);var A=class{constructor(){this.httpClient=_axios2.default}get(e,o,i){return this.httpClient.get(e,{params:o,headers:i})}downloadVideoFile(e){return this.httpClient.get(e,{responseType:"stream"})}},f=new A;function D(t,e,o){return a(this,null,function*(){var i;try{let{data:r}=yield f.get("https://www.linkedin.com/learning-api/videos",e,o),s={title:t.title,progressiveStreams:r.elements.map(l=>l.presentation.videoPlay.videoPlayMetadata.progressiveStreams).reduce((l,d)=>[...l,...d],[])};return s}catch(r){throw n.out({text:`Could not locate downloadable video with 
https://www.linkedin.com/learning-api/videos?parentSlug=${e.parentSlug}&q=slugs&slug=${e.slug}
Make sure the video is not behind a premium lock. Response status: ${(i=r.response)==null?void 0:i.status}`,type:"error"}),r}})}var I=class{getAuthHeaders(){return a(this,null,function*(){return this.authHeaders||(this.authHeaders=yield this.promptUserForTokens()),this.authHeaders})}promptUserForTokens(){return a(this,null,function*(){let e;do e=yield n.promptUserInput({text:"Please enter CSRF token:",type:"prompt"});while(!e);let o;do o=yield n.promptUserInput({text:"Please enter the cookie:",type:"prompt"});while(!o);return{"csrf-token":e,cookie:o}})}},x=new I;function U(t){return a(this,null,function*(){let{parentSlug:e}=t,o="slugs",i=yield x.getAuthHeaders(),r=4e4,s=59,l=0,d,m=[];do{d=t.videos.slice(l,l+s),l+=s;let c=yield Promise.all(d.map(p=>a(this,null,function*(){return D(p,{parentSlug:e,q:o,slug:p.slug},i)})));d.length===s&&(yield new Promise(p=>{n.out({text:`
Sleeping for ${r/1e3} seconds to prevent 429 server error
`,type:"info"}),setTimeout(()=>p(!0),r)})),m.push(...c)}while(d.length);return m})}var _jsdom = require('jsdom');function C(t){return a(this,null,function*(){var l;let e;e=(l=t.match(/\/([^/]+)$/))==null?void 0:l[1];let{data:o}=yield f.get(t),{window:{document:i}}=new (0, _jsdom.JSDOM)(o),r=i.title,s=Array.from(i.querySelectorAll(".video__link")).map(d=>{var m,c,p,u;return{title:(c=(m=d.querySelector(".video__title"))==null?void 0:m.textContent)==null?void 0:c.trim(),slug:(u=(p=d.getAttribute("href"))==null?void 0:p.match(/\/([^/]+)\?/))==null?void 0:u[1].trim()}});return{listName:r,parentSlug:e,videos:s}})}var k=`
Please enter url to a linkedin course you would like to download?
i.e. https://www.linkedin.com/learning/critical-thinking-for-better-judgment-and-decision-making
`,E="Invalid course url entered, enter a valid one.";function L(t){return/^https?:\/\/(www\.)?linkedin\.com\/learning\/[a-z\-_\d]+$/.test(t)}function S(){return a(this,null,function*(){let t;for(;;){t=yield n.promptUserInput({text:k,type:"prompt"});let e=L(t);if(e)break;n.out({text:E,type:"error"})}return t})}var _fs = require('fs');function T(t){return a(this,null,function*(){let e="";do{let o=yield n.promptUserInput({text:`
Please enter the path to the download folder:
`,type:"prompt"});if(/^\..+$/.test(o)&&(o=`${t}/${/[\\/]/.test(o[1])?o.slice(2):o}`),!_fs.existsSync.call(void 0, o)){n.out({text:`
Error: folder does not exist!`,type:"error"});continue}e=o}while(!e);return e})}function y(t){return a(this,null,function*(){let e=t.reduce((r,s)=>[...r,s.progressiveStreams.map(({width:l})=>l)],[]),o=t[0].progressiveStreams.map(({width:r})=>r).filter(r=>e.every(s=>s.includes(r))),i=0;do{let r=Number.parseInt(yield n.promptUserInput({text:`
Please, select desired video width: ${o.join(", ")}: `,type:"prompt"}));Number.isInteger(r)&&o.includes(r)&&(i=r)}while(!i);return i})}function F(t){return t.reduce((e,o,i)=>{let r=M(o.transcriptStartAt),s=i===t.length-1;if(s)r+=`
`;else{let d=M(t[i+1].transcriptStartAt);r+=` --> ${d}
`}let l=`${++i}
${r}${o.caption}

`;return e+l},"")}function M(t){let e=(t%1e3).toLocaleString("en-US",{minimumIntegerDigits:3,useGrouping:!1}),o=Math.trunc(t/1e3).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1}),i=Math.trunc(t/1e3/60).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1}),r=Math.trunc(t/1e3/60/60).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1});return`${r}:${i}:${o},${e}`}function R(t){let{window:{document:e}}=new (0, _jsdom.JSDOM)(t),o=Array.from(e.querySelectorAll('code[style="display: none"]')).find(s=>{var l;return(l=s.textContent)==null?void 0:l.includes("transcriptStartAt")}),i=JSON.parse(o.textContent.replace(/&quot/g,'"')),{lines:r}=i.included.find(({lines:s})=>Boolean(s));return r||[]}function b(t){return a(this,null,function*(){let e=yield x.getAuthHeaders();return f.get(t,void 0,e).then(({data:o})=>R(o)).then(F)})}function h(t,e){return`${++t} ${K(e)}`}function K(t){return t.replace(/[/:*?"<>|~#%&+{}\-\\]/g,"")}function w(t,e){return/\/$/.test(t)?`${t}${e}`:`${t}/${e}`}function _(t,e,o){return a(this,null,function*(){let i;do i=yield n.promptUserInput({text:"Download subtitles? (y/n) ",type:"prompt"});while(!/^[yn]$/i.test(i));if(/^y$/i.test(i)){let r=0,s=t.videos.length;yield Promise.all(t.videos.map((c,p)=>a(this,[c,p],function*({title:l,slug:d},m){let u=`${h(m,l)}.srt`;try{let g=yield b(`${e}/${d}`);if(!g)throw"Could not find/parse subtitles";let q=w(o,u);yield _fs.promises.writeFile(q,g),++r,n.out({text:`File successfully downloaded: ${u}`,type:"success"}),n.out({text:`Subtitles downloaded: ${r} / ${s}`,type:"success"})}catch(g){n.out({text:`Could not get subtitles for ${u}: ${g.toString()}`,type:"error"})}}))),n.out({text:`
Finished downloading subtitles: ${r} / ${t.videos.length}.`,type:"success"})}})}function O(t,e,o){return a(this,null,function*(){let i=_fs.createWriteStream.call(void 0, e);n.out({text:`Downloading ${o} from 
${t}`,type:"info"});let{data:r}=yield f.downloadVideoFile(t);return new Promise((s,l)=>{r.pipe(i);let d=null;i.on("error",m=>{d=m,i.close(),l(m)}),i.on("close",()=>{d||s()})})})}function H(t,e,o){return a(this,null,function*(){let i=0,r=t.length,s=[];yield Promise.all(t.map((l,d)=>a(this,null,function*(){let m=l.progressiveStreams.find(({width:g})=>g===e),c=`${h(d,l.title)}.${m.mediaType.split("/")[1]}`,p=m==null?void 0:m.streamingLocations[0].url,u=w(o,c);try{yield O(p,u,c),++i,n.out({text:`File successfully downloaded: ${c}`,type:"success"}),n.out({text:`Downloads progress: ${i} / ${r}`,type:"info"})}catch(g){n.out({text:`Error saving video ${c}: ${g.toString()}`,type:"error"}),s.push(`${c}
${p}`)}}))),n.out({text:`
Finished downloading videos: ${i} / ${t.length}`,type:"success"}),s.length&&n.out({text:`
Unfortunately, ${s.length} videos could not be downloaded: ${s.join(`
`)}`,type:"error"})})}function N(t){return a(this,null,function*(){let e=yield S(),o=yield C(e);n.out({text:X(o.videos),type:"success"});let i=yield U(o),r=yield y(i);n.out({text:`Selected video width: ${r}`,type:"success"});let s=yield T(t);n.out({text:`Download path: ${s}`,type:"success"}),yield H(i,r,s),yield _(o,e,s)})}function X(t){return`
Found ${t.length} videos:

${t.map(({title:e},o)=>`${++o}. ${e}.`).join(`
`)}`}function P(){return a(this,null,function*(){n.out({text:V,type:"info"});let t=!1;do{yield N(__dirname);let e;do e=yield n.promptUserInput({text:"Download another course? (y/n) ",type:"prompt"});while(!/^[yn]$/i.test(e));t=/^n$/i.test(e)}while(!t);n.out({text:"Bye bye!",type:"info"}),process.exit()})}P();
