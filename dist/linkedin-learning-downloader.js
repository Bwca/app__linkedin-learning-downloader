"use strict"; function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var a=(e,t,o)=>new Promise((r,i)=>{var s=d=>{try{l(o.next(d))}catch(p){i(p)}},c=d=>{try{l(o.throw(d))}catch(p){i(p)}},l=d=>d.done?r(d.value):Promise.resolve(d.value).then(s,c);l((o=o.apply(e,t)).next())});var _fs = require('fs');var _readline = require('readline'); var _readline2 = _interopRequireDefault(_readline);var _chalk = require('chalk'); var _chalk2 = _interopRequireDefault(_chalk);var k=class{out(t){let o=this.messageToColoredString(t);console.log(o)}promptUserInput(t){return new Promise(o=>{let r=this.messageToColoredString(t),i=this.readlineInterface;i.question(r,s=>{o(s.trim()),i.close()})})}promtUserUntilValidInput(t,o,r){return a(this,null,function*(){let i,s=!1;do i=yield this.promptUserInput(t),s=o(i),!s&&r&&this.out(r);while(!s);return i})}get readlineInterface(){return _readline2.default.createInterface({input:process.stdin,output:process.stdout})}messageToColoredString({text:t,type:o}){switch(o){case"success":return _chalk2.default.green.bold(t);case"info":return _chalk2.default.whiteBright(t);case"error":return _chalk2.default.red.bold(t);case"prompt":return _chalk2.default.cyan.bold(t);default:return t}}},n=new k;var _axios = require('axios'); var _axios2 = _interopRequireDefault(_axios);var I=class{constructor(){this.httpClient=_axios2.default}get(t,o,r){return this.httpClient.get(t,{params:o,headers:r})}downloadVideoFile(t){return this.httpClient.get(t,{responseType:"stream"})}},f=new I;function y(e,t,o){return a(this,null,function*(){let r=_fs.createWriteStream.call(void 0, t);n.out({text:`Downloading ${o} from 
${e.slice(0,20)}...`,type:"info"});let{data:i}=yield f.downloadVideoFile(e);return new Promise((s,c)=>{i.pipe(r);let l=null;r.on("error",d=>{l=d,r.close(),c(d)}),r.on("close",()=>{l||s()})})})}var _jsdom = require('jsdom');function w(t){return a(this,arguments,function*({data:e}){let{window:{document:o}}=new (0, _jsdom.JSDOM)(e);return o})}function h(e,t){return`${++e} ${W(t)}`}function W(e){return e.replace(/[/:*?"<>|~#%&+{}\-\\]/g,"")}var T=class{getAuthHeaders(){return a(this,null,function*(){return this.authHeaders||(this.authHeaders=(yield this.loadTokensFromFile())||(yield this.promptUserForTokens())),this.authHeaders})}loadTokensFromFile(){return a(this,null,function*(){let t=`${__dirname}/cookie.token`,o=`${__dirname}/csrf.token`;if(!_fs.existsSync.call(void 0, t)||!_fs.existsSync.call(void 0, o))return;try{let r=yield _fs.promises.readFile(t),i=yield _fs.promises.readFile(o),s={"csrf-token":i.toString(),cookie:r.toString()};if(!s.cookie||!s["csrf-token"])throw"Invalid tokens!";return s}catch(r){n.out({text:r.toString(),type:"error"})}})}promptUserForTokens(){return a(this,null,function*(){let t=yield n.promtUserUntilValidInput({text:"Please enter CSRF token:",type:"prompt"},Boolean),o=yield n.promtUserUntilValidInput({text:"Please enter the cookie:",type:"prompt"},Boolean);return{"csrf-token":t,cookie:o}})}},x=new T;function P(e,t){return a(this,null,function*(){var c;let o=Array.from(e.querySelectorAll('code[style="display: none"]')).find(l=>{var d;return(d=l.textContent)==null?void 0:d.includes("exerciseFiles")});o||n.out({text:"No exercises found for the course.",type:"info"});let r=JSON.parse(o.textContent),i=r.included.find(l=>Boolean(l.exerciseFiles));!i||!((c=i.exerciseFiles)==null?void 0:c.length)?n.out({text:`
No exercises found for the course.`,type:"info"}):n.out({text:`
Found ${i.exerciseFiles.length} exercises, downloading...`,type:"info"});let s=0;yield Promise.all(i.exerciseFiles.map((l,d)=>J(l,t,d).then(p=>{n.out({text:`${p} has been downloaded.`,type:"success"}),n.out({text:`Download progress: ${++s} / ${i.exerciseFiles.length}`,type:"info"})}).catch(p=>n.out({text:p,type:"error"}))))})}function J(e,t,o){return a(this,null,function*(){let r=h(o,e.name),i=e.url;return yield y(i,`${t}/${r}`,r),r})}function H(e,t,o){return a(this,null,function*(){let{data:r}=yield f.get("https://www.linkedin.com/learning-api/videos",t,o),i={title:e.title,progressiveStreams:r.elements.map(s=>s.presentation.videoPlay.videoPlayMetadata.progressiveStreams).reduce((s,c)=>[...s,...c],[])};return i})}function R(e){return a(this,null,function*(){var d;let{parentSlug:t}=e,o="slugs",r=yield x.getAuthHeaders(),i=15e3,s=15e3,c=[],l=[];do{let p=l.length?l:e.videos;for(let u of p){n.out({text:`Requesting video options for ${u.title}...`,type:"info"});try{let g=yield H(u,{parentSlug:t,q:o,slug:u.slug},r);c.push(g),l=l.filter(({slug:m})=>m!==u.slug),n.out({text:"Success!",type:"success"})}catch(g){let m=((d=g==null?void 0:g.response)==null?void 0:d.status)===429;if(m)n.out({text:"Encountered error 429: too many requests",type:"error"});else throw g;l.push(u),yield new Promise(b=>{n.out({text:`
Sleeping for ${s/1e3} seconds before continuing to prevent 429 error
Videos resolved: ${c.length} / ${e.videos.length}`,type:"info"}),s+=i,setTimeout(()=>b(!0),s)})}}l.length&&n.out({text:`Retrying requests for ${l.length} videos...`,type:"info"})}while(l.length);return c})}function L(e,t){return a(this,null,function*(){var s;let o;o=(s=e.match(/\/([^/]+)$/))==null?void 0:s[1];let r=t.title,i=Array.from(t.querySelectorAll(".video__link")).map(c=>{var l,d,p,u;return{title:(d=(l=c.querySelector(".video__title"))==null?void 0:l.textContent)==null?void 0:d.trim(),slug:(u=(p=c.getAttribute("href"))==null?void 0:p.match(/\/([^/]+)\?/))==null?void 0:u[1].trim()}});return{listName:r,parentSlug:o,videos:i}})}function M(e){return/^https?:\/\/(www\.)?linkedin\.com\/learning\/[a-z\-_\d]+$/.test(e)}function $(){return a(this,null,function*(){return n.promtUserUntilValidInput({text:`
Please enter url to a linkedin course you would like to download?
      i.e. https://www.linkedin.com/learning/critical-thinking-for-better-judgment-and-decision-making
`,type:"prompt"},e=>M(e),{text:"Invalid course url entered, enter a valid one.",type:"error"})})}function E(e){return a(this,null,function*(){let t="";do{let o=yield n.promptUserInput({text:`
Please enter the path to the download folder:
`,type:"prompt"});if(/^\..+$/.test(o)&&(o=`${e}/${/[\\/]/.test(o[1])?o.slice(2):o}`),!_fs.existsSync.call(void 0, o)){n.out({text:`
Folder does not exist, trying to create it...`,type:"info"});try{_fs.mkdirSync.call(void 0, o),n.out({text:"Folder created!",type:"success"})}catch(r){n.out({text:`Error while trying to create folder: ${r.toString()}`,type:"error"});continue}}t=o}while(!t);return t})}function V(e){return a(this,null,function*(){let t=e.reduce((r,i)=>[...r,i.progressiveStreams.map(({width:s})=>s)],[]),o=e[0].progressiveStreams.map(({width:r})=>r).filter(r=>t.every(i=>i.includes(r)));return Number.parseInt(yield n.promtUserUntilValidInput({text:`
Please, select desired video width: ${o.join(", ")}: `,type:"prompt"},r=>o.map(String).includes(r)))})}function N(e){return e.reduce((t,o,r)=>{let i=q(o.transcriptStartAt),s=r===e.length-1;if(s)i+=`
`;else{let l=q(e[r+1].transcriptStartAt);i+=` --> ${l}
`}let c=`${++r}
${i}${o.caption}

`;return t+c},"")}function q(e){let t=(e%1e3).toLocaleString("en-US",{minimumIntegerDigits:3,useGrouping:!1}),o=Math.trunc(e/1e3).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1}),r=Math.trunc(e/1e3/60).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1}),i=Math.trunc(e/1e3/60/60).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1});return`${i}:${r}:${o},${t}`}function O(e){let t=Array.from(e.querySelectorAll('code[style="display: none"]')).find(i=>{var s;return(s=i.textContent)==null?void 0:s.includes("transcriptStartAt")});if(!t)throw"Could not locate subtitles on the page, check if they are missing";let o=JSON.parse(t.textContent.replace(/&quot/g,'"')),{lines:r}=o.included.find(({lines:i})=>Boolean(i));return r||[]}function F(e){return a(this,null,function*(){let t=yield x.getAuthHeaders();return f.get(e,void 0,t).then(w).then(O).then(N)})}function v(e,t){return/\/$/.test(e)?`${e}${t}`:`${e}/${t}`}function _(e,t,o){return a(this,null,function*(){let r=yield n.promtUserUntilValidInput({text:`
Download subtitles? (y/n) `,type:"prompt"},i=>/^[yn]$/i.test(i));if(/^y$/i.test(r)){let i=0,s=e.videos.length;yield Promise.all(e.videos.map((p,u)=>a(this,[p,u],function*({title:c,slug:l},d){let g=`${h(d,c)}.srt`;try{let m=yield F(`${t}/${l}`);if(!m)throw"Could not find/parse subtitles";let b=v(o,g);yield _fs.promises.writeFile(b,m),++i,n.out({text:`File successfully downloaded: ${g}`,type:"success"}),n.out({text:`Subtitles downloaded: ${i} / ${s}`,type:"info"})}catch(m){n.out({text:`Could not get subtitles for ${g}: ${m.toString()}`,type:"error"})}}))),n.out({text:`
Finished downloading subtitles: ${i} / ${e.videos.length}.`,type:"success"})}})}function B(e,t,o){return a(this,null,function*(){let r=0,i=e.length,s=[];yield Promise.all(e.map((c,l)=>a(this,null,function*(){let d=c.progressiveStreams.find(({width:m})=>m===t),p=`${h(l,c.title)}.${d.mediaType.split("/")[1]}`,u=d==null?void 0:d.streamingLocations[0].url,g=v(o,p);try{yield y(u,g,p),++r,n.out({text:`File successfully downloaded: ${p}`,type:"success"}),n.out({text:`Downloads progress: ${r} / ${i}`,type:"info"})}catch(m){n.out({text:`Error saving video ${p}: ${m.toString()}`,type:"error"}),s.push(`${p}
${u}`)}}))),n.out({text:`
Finished downloading videos: ${r} / ${e.length}`,type:"success"}),s.length&&n.out({text:`
Unfortunately, ${s.length} videos could not be downloaded: ${s.join(`
`)}`,type:"error"})})}function A(e){return a(this,null,function*(){let t=yield $(),o=yield f.get(t).then(w),r=yield L(t,o);n.out({text:Z(r.videos),type:"success"});let i=yield R(r),s=yield V(i);n.out({text:`Selected video width: ${s}`,type:"success"});let c=yield E(e);n.out({text:`Download path: ${c}
`,type:"info"}),yield B(i,s,c);let l=yield x.getAuthHeaders(),d=yield f.get(t,void 0,l).then(w);yield P(d,c),yield _(r,t,c)})}function Z(e){return`
Found ${e.length} videos:

${e.map(({title:t},o)=>`${++o}. ${t}.`).join(`
`)}`}function D(){return a(this,null,function*(){n.out({text:`
Welcome to the Linkedin learning videos downloade v1!`,type:"info"});let e=!1;do{yield A(__dirname);let t=yield n.promtUserUntilValidInput({text:`
Download another course? (y/n) `,type:"prompt"},o=>/^[yn]$/i.test(o));e=/^n$/i.test(t)}while(!e);n.out({text:`Bye bye!

`,type:"info"}),process.exit()})}D();
