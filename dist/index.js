"use strict"; function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var n=(o,e,t)=>new Promise((s,r)=>{var a=d=>{try{p(t.next(d))}catch(m){r(m)}},l=d=>{try{p(t.throw(d))}catch(m){r(m)}},p=d=>d.done?s(d.value):Promise.resolve(d.value).then(a,l);p((t=t.apply(o,e)).next())}),v=`
Welcome to the Linkedin learning videos downloade v1!`;var _fs = require('fs');var _readline = require('readline'); var _readline2 = _interopRequireDefault(_readline);var _chalk = require('chalk'); var _chalk2 = _interopRequireDefault(_chalk);var x=class{out(e){let t=this.messageToColoredString(e);console.log(t)}promptUserInput(e){return new Promise(t=>{let s=this.messageToColoredString(e),r=this.readlineInterface;r.question(s,a=>{t(a.trim()),r.close()})})}get readlineInterface(){return _readline2.default.createInterface({input:process.stdin,output:process.stdout})}messageToColoredString({text:e,type:t}){switch(t){case"success":return _chalk2.default.green.bold(e);case"info":return _chalk2.default.whiteBright(e);case"error":return _chalk2.default.red.bold(e);case"prompt":return _chalk2.default.cyan.bold(e);default:return e}}},i=new x;var _axios = require('axios'); var _axios2 = _interopRequireDefault(_axios);var y=class{constructor(){this.httpClient=_axios2.default}get(e,t,s){return this.httpClient.get(e,{params:t,headers:s})}downloadVideoFile(e){return this.httpClient.get(e,{responseType:"stream"})}},u=new y;function S(o,e,t){return n(this,null,function*(){let s=_fs.createWriteStream.call(void 0, e);i.out({text:`Downloading ${t} from 
${o}`,type:"info"});let{data:r}=yield u.downloadVideoFile(o);return new Promise((a,l)=>{r.pipe(s);let p=null;s.on("error",d=>{p=d,i.out({text:`Could not download file ${t}
Download error: ${d.toString()}`,type:"error"}),s.close(),l(d)}),s.on("close",()=>{p||(i.out({text:`File successfully downloaded: ${t}`,type:"success"}),a())})})})}function P(o,e,t){return n(this,null,function*(){let{data:s}=yield u.get("https://www.linkedin.com/learning-api/videos",e,t);try{let r={title:o.title,progressiveStreams:s.elements.map(a=>a.presentation.videoPlay.videoPlayMetadata.progressiveStreams).reduce((a,l)=>[...a,...l],[])};return r}catch(r){throw i.out({text:`Could not locate downloadable video with 
https://www.linkedin.com/learning-api/videos?parentSlug=${e.parentSlug}&q=slugs&slug=${e.slug}
Make sure the video is not behind a premium lock.`,type:"error"}),r}})}var V=class{getAuthHeaders(){return n(this,null,function*(){return this.authHeaders||(this.authHeaders=yield this.promptUserForTokens()),this.authHeaders})}promptUserForTokens(){return n(this,null,function*(){let e;do e=yield i.promptUserInput({text:"Please enter CSRF token:",type:"prompt"});while(!e);let t;do t=yield i.promptUserInput({text:"Please enter the cookie:",type:"prompt"});while(!t);return{"csrf-token":e,cookie:t}})}},b=new V;function A(o){return n(this,null,function*(){let{parentSlug:e}=o,t="slugs",s=yield b.getAuthHeaders();return Promise.all(o.videos.map(r=>n(this,null,function*(){return P(r,{parentSlug:e,q:t,slug:r.slug},s)})))})}var _jsdom = require('jsdom');function k(o){return n(this,null,function*(){var l;let e;e=(l=o.match(/\/([^/]+)$/))==null?void 0:l[1];let{data:t}=yield u.get(o),{window:{document:s}}=new (0, _jsdom.JSDOM)(t),r=s.title,a=Array.from(s.querySelectorAll(".video__link")).map(p=>{var d,m,g,c;return{title:(m=(d=p.querySelector(".video__title"))==null?void 0:d.textContent)==null?void 0:m.trim(),slug:(c=(g=p.getAttribute("href"))==null?void 0:g.match(/\/([^/]+)\?/))==null?void 0:c[1].trim()}});return{listName:r,parentSlug:e,videos:a}})}var C=`
Please enter url to a linkedin course you would like to download?
i.e. https://www.linkedin.com/learning/critical-thinking-for-better-judgment-and-decision-making
`,U="Invalid course url entered, enter a valid one.";function $(o){return/^https?:\/\/(www\.)?linkedin\.com\/learning\/[a-z\-_\d]+$/.test(o)}function h(){return n(this,null,function*(){let o;for(;;){o=yield i.promptUserInput({text:C,type:"prompt"});let e=$(o);if(e)break;i.out({text:U,type:"error"})}return o})}function E(o){return n(this,null,function*(){let e="";do{let t=yield i.promptUserInput({text:`
Please enter the path to the download folder:
`,type:"prompt"});if(/^\..+$/.test(t)&&(t=`${o}/${/[\\/]/.test(t[1])?t.slice(2):t}`),!_fs.existsSync.call(void 0, t)){i.out({text:`
Error: folder does not exist!`,type:"error"});continue}e=t}while(!e);return e})}function w(o){return n(this,null,function*(){let e=o.reduce((r,a)=>[...r,a.progressiveStreams.map(({width:l})=>l)],[]),t=o[0].progressiveStreams.map(({width:r})=>r).filter(r=>e.every(a=>a.includes(r))),s=0;do{let r=Number.parseInt(yield i.promptUserInput({text:`
Please, select desired video width: ${t.join(", ")}: `,type:"prompt"}));Number.isInteger(r)&&t.includes(r)&&(s=r)}while(!s);return s})}function D(){return n(this,null,function*(){let o=yield h(),e=yield k(o);i.out({text:q(e.videos),type:"success"});let t=yield A(e),s=yield w(t);i.out({text:`Selected video width: ${s}`,type:"success"});let r=yield E(__dirname);i.out({text:`Download path: ${r}`,type:"success"}),yield Promise.all(t.map((d,m)=>n(this,[d,m],function*({progressiveStreams:a,title:l},p){let g=a.find(({width:L})=>L===s),c=`${++p} ${l.replace(/[/:*?"<>|~#%&+{}\-\\]/g,"")}.${g.mediaType.split("/")[1]}`,M=g==null?void 0:g.streamingLocations[0].url,I=/\/$/.test(r)?`${r}${c}`:`${r}/${c}`;return S(M,I,c)}))),i.out({text:`
Downloading finished.`,type:"success"})})}function q(o){return`
Found ${o.length} videos:

${o.map(({title:e},t)=>`${++t}. ${e}.`).join(`
`)}`}function R(){return n(this,null,function*(){i.out({text:v,type:"info"});let o=!1;do{yield D();let e;do e=yield i.promptUserInput({text:"Download another course? (y/n) ",type:"prompt"});while(!/^[yn]$/i.test(e));o=/^n$/i.test(e)}while(!o);i.out({text:"Bye bye!",type:"info"}),process.exit()})}R();
