"use strict"; function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var s=(t,e,o)=>new Promise((i,r)=>{var a=d=>{try{m(o.next(d))}catch(p){r(p)}},l=d=>{try{m(o.throw(d))}catch(p){r(p)}},m=d=>d.done?i(d.value):Promise.resolve(d.value).then(a,l);m((o=o.apply(t,e)).next())}),P=`
Welcome to the Linkedin learning videos downloade v1!`;var _readline = require('readline'); var _readline2 = _interopRequireDefault(_readline);var _chalk = require('chalk'); var _chalk2 = _interopRequireDefault(_chalk);var V=class{out(e){let o=this.messageToColoredString(e);console.log(o)}promptUserInput(e){return new Promise(o=>{let i=this.messageToColoredString(e),r=this.readlineInterface;r.question(i,a=>{o(a.trim()),r.close()})})}get readlineInterface(){return _readline2.default.createInterface({input:process.stdin,output:process.stdout})}messageToColoredString({text:e,type:o}){switch(o){case"success":return _chalk2.default.green.bold(e);case"info":return _chalk2.default.whiteBright(e);case"error":return _chalk2.default.red.bold(e);case"prompt":return _chalk2.default.cyan.bold(e);default:return e}}},n=new V;var _axios = require('axios'); var _axios2 = _interopRequireDefault(_axios);var $=class{constructor(){this.httpClient=_axios2.default}get(e,o,i){return this.httpClient.get(e,{params:o,headers:i})}downloadVideoFile(e){return this.httpClient.get(e,{responseType:"stream"})}},g=new $;function A(t,e,o){return s(this,null,function*(){let{data:i}=yield g.get("https://www.linkedin.com/learning-api/videos",e,o);try{let r={title:t.title,progressiveStreams:i.elements.map(a=>a.presentation.videoPlay.videoPlayMetadata.progressiveStreams).reduce((a,l)=>[...a,...l],[])};return r}catch(r){throw n.out({text:`Could not locate downloadable video with 
https://www.linkedin.com/learning-api/videos?parentSlug=${e.parentSlug}&q=slugs&slug=${e.slug}
Make sure the video is not behind a premium lock.`,type:"error"}),r}})}var D=class{getAuthHeaders(){return s(this,null,function*(){return this.authHeaders||(this.authHeaders=yield this.promptUserForTokens()),this.authHeaders})}promptUserForTokens(){return s(this,null,function*(){let e;do e=yield n.promptUserInput({text:"Please enter CSRF token:",type:"prompt"});while(!e);let o;do o=yield n.promptUserInput({text:"Please enter the cookie:",type:"prompt"});while(!o);return{"csrf-token":e,cookie:o}})}},v=new D;function C(t){return s(this,null,function*(){let{parentSlug:e}=t,o="slugs",i=yield v.getAuthHeaders();return Promise.all(t.videos.map(r=>s(this,null,function*(){return A(r,{parentSlug:e,q:o,slug:r.slug},i)})))})}var _jsdom = require('jsdom');function I(t){return s(this,null,function*(){var l;let e;e=(l=t.match(/\/([^/]+)$/))==null?void 0:l[1];let{data:o}=yield g.get(t),{window:{document:i}}=new (0, _jsdom.JSDOM)(o),r=i.title,a=Array.from(i.querySelectorAll(".video__link")).map(m=>{var d,p,u,c;return{title:(p=(d=m.querySelector(".video__title"))==null?void 0:d.textContent)==null?void 0:p.trim(),slug:(c=(u=m.getAttribute("href"))==null?void 0:u.match(/\/([^/]+)\?/))==null?void 0:c[1].trim()}});return{listName:r,parentSlug:e,videos:a}})}var U=`
Please enter url to a linkedin course you would like to download?
i.e. https://www.linkedin.com/learning/critical-thinking-for-better-judgment-and-decision-making
`,k="Invalid course url entered, enter a valid one.";function L(t){return/^https?:\/\/(www\.)?linkedin\.com\/learning\/[a-z\-_\d]+$/.test(t)}function x(){return s(this,null,function*(){let t;for(;;){t=yield n.promptUserInput({text:U,type:"prompt"});let e=L(t);if(e)break;n.out({text:k,type:"error"})}return t})}var _fs = require('fs');function E(t){return s(this,null,function*(){let e="";do{let o=yield n.promptUserInput({text:`
Please enter the path to the download folder:
`,type:"prompt"});if(/^\..+$/.test(o)&&(o=`${t}/${/[\\/]/.test(o[1])?o.slice(2):o}`),!_fs.existsSync.call(void 0, o)){n.out({text:`
Error: folder does not exist!`,type:"error"});continue}e=o}while(!e);return e})}function y(t){return s(this,null,function*(){let e=t.reduce((r,a)=>[...r,a.progressiveStreams.map(({width:l})=>l)],[]),o=t[0].progressiveStreams.map(({width:r})=>r).filter(r=>e.every(a=>a.includes(r))),i=0;do{let r=Number.parseInt(yield n.promptUserInput({text:`
Please, select desired video width: ${o.join(", ")}: `,type:"prompt"}));Number.isInteger(r)&&o.includes(r)&&(i=r)}while(!i);return i})}function T(t){return t.reduce((e,o,i)=>{let r=M(o.transcriptStartAt),a=i===t.length-1;if(a)r+=`
`;else{let m=M(t[i+1].transcriptStartAt);r+=` --> ${m}
`}let l=`${++i}
${r}${o.caption}

`;return e+l},"")}function M(t){let e=(t%1e3).toLocaleString("en-US",{minimumIntegerDigits:3,useGrouping:!1}),o=Math.trunc(t/1e3).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1}),i=Math.trunc(t/1e3/60).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1}),r=Math.trunc(t/1e3/60/60).toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1});return`${r}:${i}:${o},${e}`}function F(t){let{window:{document:e}}=new (0, _jsdom.JSDOM)(t),o=Array.from(e.querySelectorAll('code[style="display: none"]')).find(a=>{var l;return(l=a.textContent)==null?void 0:l.includes("transcriptStartAt")}),i=JSON.parse(o.textContent.replace(/&quot/g,'"')),{lines:r}=i.included.find(({lines:a})=>Boolean(a));return r||[]}function b(t){return s(this,null,function*(){let e=yield v.getAuthHeaders();return g.get(t,void 0,e).then(({data:o})=>F(o)).then(T)})}function f(t,e){return`${++t} ${K(e)}`}function K(t){return t.replace(/[/:*?"<>|~#%&+{}\-\\]/g,"")}function h(t,e){return/\/$/.test(t)?`${t}${e}`:`${t}/${e}`}function R(t,e,o){return s(this,null,function*(){let i;do i=yield n.promptUserInput({text:"Download subtitles? (y/n) ",type:"prompt"});while(!/^[yn]$/i.test(i));if(/^y$/i.test(i)){let r=0;yield Promise.all(t.videos.map((d,p)=>s(this,[d,p],function*({title:a,slug:l},m){let u=`${f(m,a)}.srt`;try{let c=yield b(`${e}/${l}`);if(!c)throw"Could not find/parse subtitles";let S=h(o,u);return _fs.promises.writeFile(S,c).then(()=>++r)}catch(c){n.out({text:`Could not get subtitles for ${u}: ${c.toString()}`,type:"error"})}}))),n.out({text:`
Finished downloading subtitles: ${r} / ${t.videos.length}.`,type:"success"})}})}function _(t,e,o){return s(this,null,function*(){let i=_fs.createWriteStream.call(void 0, e);n.out({text:`Downloading ${o} from 
${t}`,type:"info"});let{data:r}=yield g.downloadVideoFile(t);return new Promise((a,l)=>{r.pipe(i);let m=null;i.on("error",d=>{m=d,n.out({text:`Could not download file ${o}
Download error: ${d.toString()}`,type:"error"}),i.close(),l(d)}),i.on("close",()=>{m||(n.out({text:`File successfully downloaded: ${o}`,type:"success"}),a())})})})}function O(t,e,o){return s(this,null,function*(){let i=0;yield Promise.all(t.map((m,d)=>s(this,[m,d],function*({progressiveStreams:r,title:a},l){let p=r.find(({width:q})=>q===e),u=`${f(l,a)}.${p.mediaType.split("/")[1]}`,c=p==null?void 0:p.streamingLocations[0].url,S=h(o,u);return _(c,S,u).then(()=>++i)}))),n.out({text:`
Finished downloading videos: ${i} / ${t.length}`,type:"success"})})}function H(t){return s(this,null,function*(){let e=yield x(),o=yield I(e);n.out({text:X(o.videos),type:"success"});let i=yield C(o),r=yield y(i);n.out({text:`Selected video width: ${r}`,type:"success"});let a=yield E(t);n.out({text:`Download path: ${a}`,type:"success"}),yield O(i,r,a),yield R(o,e,a)})}function X(t){return`
Found ${t.length} videos:

${t.map(({title:e},o)=>`${++o}. ${e}.`).join(`
`)}`}function N(){return s(this,null,function*(){n.out({text:P,type:"info"});let t=!1;do{yield H(__dirname);let e;do e=yield n.promptUserInput({text:"Download another course? (y/n) ",type:"prompt"});while(!/^[yn]$/i.test(e));t=/^n$/i.test(e)}while(!t);n.out({text:"Bye bye!",type:"info"}),process.exit()})}N();
